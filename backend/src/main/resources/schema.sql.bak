-- StreetBite MySQL Database Schema (Updated & Verified)
-- This script creates all tables matching the JPA entities exactly
-- Database: streetbite

-- Drop existing tables if they exist (in correct order to handle foreign keys)
DROP TABLE IF EXISTS search_history;
DROP TABLE IF EXISTS favorites;
DROP TABLE IF EXISTS review_images;
DROP TABLE IF EXISTS reviews;
DROP TABLE IF EXISTS order_items;
DROP TABLE IF EXISTS orders;
DROP TABLE IF EXISTS user_favorites;
DROP TABLE IF EXISTS promotions;
DROP TABLE IF EXISTS menu_items;
DROP TABLE IF EXISTS vendor_images;
DROP TABLE IF EXISTS vendors;
DROP TABLE IF EXISTS users;
DROP TABLE IF EXISTS reports;
DROP TABLE IF EXISTS geocode_cache;

-- ============================================================================
-- USERS TABLE
-- Stores user accounts (customers, vendors, admins)
-- Linked to Firebase Auth via firebase_uid
-- ============================================================================
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    firebase_uid VARCHAR(255) NOT NULL UNIQUE COMMENT 'Links to Firebase Authentication',
    email VARCHAR(255),
    display_name VARCHAR(255),
    phone_number VARCHAR(50),
    role ENUM('USER', 'VENDOR', 'ADMIN') NOT NULL DEFAULT 'USER',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_firebase_uid (firebase_uid),
    INDEX idx_email (email),
    INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='User accounts with Firebase Auth integration';

-- ============================================================================
-- VENDORS TABLE
-- Stores street food vendor business information
-- ============================================================================
CREATE TABLE vendors (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    owner_id BIGINT COMMENT 'Foreign key to users table',
    name VARCHAR(255) NOT NULL,
    description TEXT,
    cuisine VARCHAR(255),
    address VARCHAR(500),
    latitude DOUBLE COMMENT 'GPS latitude for vendor location',
    longitude DOUBLE COMMENT 'GPS longitude for vendor location',
    rating DOUBLE DEFAULT 0.0 COMMENT 'Average rating from reviews',
    phone VARCHAR(50),
    hours VARCHAR(255) COMMENT 'Operating hours',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'Vendor active status',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_location (latitude, longitude),
    INDEX idx_owner (owner_id),
    INDEX idx_active (is_active),
    INDEX idx_cuisine (cuisine),
    INDEX idx_rating (rating)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Street food vendor profiles';

-- ============================================================================
-- VENDOR IMAGES TABLE
-- Stores gallery images for vendors
-- ============================================================================
CREATE TABLE vendor_images (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    vendor_id BIGINT NOT NULL,
    image_url VARCHAR(500) NOT NULL,
    
    FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE,
    INDEX idx_vendor (vendor_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Vendor gallery images';

-- ============================================================================
-- MENU ITEMS TABLE
-- Stores menu items for each vendor
-- ============================================================================
CREATE TABLE menu_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    vendor_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL COMMENT 'Current price',
    category VARCHAR(100),
    image_url VARCHAR(500),
    is_available BOOLEAN DEFAULT TRUE COMMENT 'Current availability (can be overridden by Firebase live_menu_updates)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE,
    INDEX idx_vendor (vendor_id),
    INDEX idx_category (category),
    INDEX idx_available (is_available),
    INDEX idx_price (price)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Vendor menu items';

-- ============================================================================
-- REVIEWS TABLE
-- Stores customer reviews for vendors
-- ============================================================================
CREATE TABLE reviews (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    vendor_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    rating INT NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_vendor (vendor_id),
    INDEX idx_user (user_id),
    INDEX idx_rating (rating),
    INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Customer reviews for vendors';

-- ============================================================================
-- REVIEW IMAGES TABLE
-- Stores images attached to reviews
-- ============================================================================
CREATE TABLE review_images (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    review_id BIGINT NOT NULL,
    image_url VARCHAR(500) NOT NULL,
    
    FOREIGN KEY (review_id) REFERENCES reviews(id) ON DELETE CASCADE,
    INDEX idx_review (review_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Images attached to reviews';

-- ============================================================================
-- ORDERS TABLE
-- Stores customer orders (persistent data)
-- Real-time status updates are in Firebase live_orders collection
-- ============================================================================
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    vendor_id BIGINT NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL,
    status ENUM('PENDING', 'PREPARING', 'READY', 'COMPLETED', 'CANCELLED') NOT NULL DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE,
    INDEX idx_user (user_id),
    INDEX idx_vendor (vendor_id),
    INDEX idx_status (status),
    INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Customer orders - persistent storage';

-- ============================================================================
-- ORDER ITEMS TABLE
-- Stores individual items in each order
-- ============================================================================
CREATE TABLE order_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_id BIGINT NOT NULL,
    menu_item_id BIGINT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    price_at_time DECIMAL(10, 2) NOT NULL COMMENT 'Price when order was placed (historical record)',
    
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (menu_item_id) REFERENCES menu_items(id) ON DELETE CASCADE,
    INDEX idx_order (order_id),
    INDEX idx_menu_item (menu_item_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Items in each order with historical pricing';

-- ============================================================================
-- USER FAVORITES TABLE
-- Many-to-many relationship between users and their favorite vendors
-- ============================================================================
CREATE TABLE user_favorites (
    user_id BIGINT NOT NULL,
    vendor_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'When user favorited this vendor',
    
    PRIMARY KEY (user_id, vendor_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE,
    INDEX idx_user (user_id),
    INDEX idx_vendor (vendor_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='User favorite vendors';

-- ============================================================================
-- PROMOTIONS TABLE
-- Stores promotional offers from vendors
-- ============================================================================
CREATE TABLE promotions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    vendor_id BIGINT NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    discount_type ENUM('PERCENTAGE', 'FIXED') COMMENT 'Type of discount',
    discount_value DECIMAL(10, 2) COMMENT 'Discount amount (percentage or fixed value)',
    start_date TIMESTAMP NULL COMMENT 'Promotion start date/time',
    end_date TIMESTAMP NULL COMMENT 'Promotion end date/time',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE,
    INDEX idx_vendor (vendor_id),
    INDEX idx_active (is_active),
    INDEX idx_dates (start_date, end_date),
    INDEX idx_discount_type (discount_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Vendor promotional offers';

-- ============================================================================
-- GEOCODE CACHE TABLE
-- Caches geocoding results to reduce Google Maps API calls
-- ============================================================================
CREATE TABLE geocode_cache (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    address VARCHAR(500) NOT NULL UNIQUE,
    latitude DOUBLE NOT NULL,
    longitude DOUBLE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_address (address),
    INDEX idx_location (latitude, longitude)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Cached geocoding results';

-- ============================================================================
-- REPORTS TABLE
-- Stores user and vendor reports/tickets
-- ============================================================================
CREATE TABLE reports (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    reporter_id BIGINT COMMENT 'User ID of the reporter (nullable)',
    reported_id BIGINT COMMENT 'ID of reported entity (nullable)',
    type VARCHAR(50) COMMENT 'USER, VENDOR, ORDER, SYSTEM',
    category VARCHAR(50) COMMENT 'BUG, COMPLAINT, SUGGESTION',
    subject VARCHAR(255),
    description TEXT,
    email VARCHAR(255),
    role VARCHAR(50) COMMENT 'CUSTOMER, VENDOR',
    reason VARCHAR(255),
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_reporter (reporter_id),
    INDEX idx_status (status),
    INDEX idx_type (type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='User and Vendor reports/tickets';

-- ============================================================================
-- VERIFICATION QUERIES
-- Run these to verify tables were created correctly
-- ============================================================================

-- Show all tables
-- SHOW TABLES;

-- Show table structures
-- DESCRIBE users;
-- DESCRIBE vendors;
-- DESCRIBE menu_items;
-- DESCRIBE reviews;
-- DESCRIBE orders;
-- DESCRIBE order_items;
-- DESCRIBE promotions;
-- DESCRIBE reports;

-- Count rows in each table
-- SELECT 'users' as table_name, COUNT(*) as row_count FROM users
-- UNION ALL SELECT 'vendors', COUNT(*) FROM vendors
-- UNION ALL SELECT 'menu_items', COUNT(*) FROM menu_items
-- UNION ALL SELECT 'reviews', COUNT(*) FROM reviews
-- UNION ALL SELECT 'orders', COUNT(*) FROM orders
-- UNION ALL SELECT 'promotions', COUNT(*) FROM promotions;
-- UNION ALL SELECT 'reports', COUNT(*) FROM reports;

-- Check foreign key relationships
-- SELECT 
--     TABLE_NAME,
--     COLUMN_NAME,
--     CONSTRAINT_NAME,
--     REFERENCED_TABLE_NAME,
--     REFERENCED_COLUMN_NAME
-- FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
-- WHERE TABLE_SCHEMA = 'streetbite'
-- AND REFERENCED_TABLE_NAME IS NOT NULL;
